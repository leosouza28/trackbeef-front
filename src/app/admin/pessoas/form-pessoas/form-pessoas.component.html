<div [class.modal-header]="isModal" *ngIf="isModal">
    <h5 class="modal-title">{{form.get('_id')?.value ? 'Editar' : 'Adicionar'}} Pessoa</h5>
    <button type="button" class="btn-close" (click)="back()" [disabled]="loading"></button>
</div>

<div [class.container-fluid]="!isModal" [class.modal-body]="isModal">
    <div class="row" *ngIf="!isModal">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="fw-bold mb-0">{{form.get('_id')?.value ? 'Editar' : 'Adicionar'}} Pessoa</h1>
                <app-help-button helpKey="pessoas-form" size="md"></app-help-button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div [class.card]="!isModal" [class.border-0]="!isModal" [class.shadow]="!isModal">
                <p class="text-muted" [class.px-3]="!isModal" [class.pt-3]="!isModal">Os campos com * são obrigatórios
                </p>
                <form [formGroup]="form" (ngSubmit)="onSubmit()" [class.px-3]="!isModal" [class.pb-3]="!isModal">
                    <div class="row g-3">

                        <!-- Tipo *-->
                        <div class="col-12">
                            <label class="form-label fw-bold">Tipo *</label>
                            <div class="d-flex gap-3">
                                <div class="form-check" *ngFor="let tipo of tipos">
                                    <input class="form-check-input" type="checkbox" [id]="'tipo_' + tipo.value"
                                        [checked]="isTipoSelecionado(tipo.value)" (change)="toggleTipo(tipo.value)">
                                    <label class="form-check-label" [for]="'tipo_' + tipo.value">
                                        {{tipo.label}}
                                    </label>
                                </div>
                            </div>
                            <div class="text-danger small mt-1"
                                *ngIf="form.get('tipos')?.invalid && form.get('tipos')?.touched">
                                Selecione ao menos um tipo
                            </div>
                        </div>

                        <!-- Tipo de Documento * -->
                        <div class="col-12 col-lg-3">
                            <label for="doc_type" class="form-label">Tipo de Documento *</label>
                            <select class="form-select" id="doc_type" formControlName="doc_type">
                                <option *ngFor="let doc of docTypes" [value]="doc.value">{{doc.label}}</option>
                            </select>
                        </div>

                        <!-- Documento * -->
                        <div class="col-12 col-lg-4">
                            <label for="documento" class="form-label">{{form.get('doc_type')?.value === 'CPF' ? 'CPF' :
                                'CNPJ'}}</label>
                            <input type="text" class="form-control" id="documento" formControlName="documento"
                                [mask]="form.get('doc_type')?.value == 'CPF' ? '000.000.000-00' : '00.000.000/0000-00'"
                                [placeholder]="form.get('doc_type')?.value === 'CPF' ? '000.000.000-00' : '00.000.000/0000-00'">
                            <!-- <div class="text-danger small mt-1"
                                *ngIf="form.get('documento')?.invalid && form.get('documento')?.touched">
                                O documento é obrigatório
                            </div> -->
                        </div>

                        <!-- Status * -->
                        <div class="col-12 col-lg-5">
                            <label for="status" class="form-label">Status *</label>
                            <select class="form-select" id="status" formControlName="status">
                                <option *ngFor="let st of status" [value]="st.value">{{st.label}}</option>
                            </select>
                        </div>

                        <!-- Nome * -->
                        <div class="col-12 col-lg-6">
                            <label for="nome" class="form-label">Nome *</label>
                            <input type="text" class="form-control" id="nome" formControlName="nome"
                                placeholder="Nome completo">
                            <div class="text-danger small mt-1"
                                *ngIf="form.get('nome')?.invalid && form.get('nome')?.touched">
                                O nome é obrigatório
                            </div>
                        </div>

                        <!-- Razão Social -->
                        <div class="col-12 col-lg-6">
                            <label for="razao_social" class="form-label">Razão Social</label>
                            <input type="text" class="form-control" id="razao_social" formControlName="razao_social"
                                placeholder="Razão social da empresa">
                        </div>

                        <!-- Email -->
                        <div class="col-12 col-lg-6">
                            <label for="email" class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="email" formControlName="email"
                                placeholder="email@exemplo.com">
                            <div class="text-danger small mt-1"
                                *ngIf="form.get('email')?.invalid && form.get('email')?.touched">
                                E-mail inválido
                            </div>
                        </div>

                        <!-- Data de Nascimento -->
                        <div class="col-12 col-lg-3" *ngIf="form.get('doc_type')?.value === 'CPF'">
                            <label for="data_nascimento" class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="data_nascimento"
                                formControlName="data_nascimento">
                        </div>

                        <!-- Sexo -->
                        <div class="col-12 col-lg-3" *ngIf="form.get('doc_type')?.value === 'CPF'">
                            <label for="sexo" class="form-label">Sexo</label>
                            <select class="form-select" id="sexo" formControlName="sexo">
                                <option value="">Selecione</option>
                                <option value="MASCULINO">Masculino</option>
                                <option value="FEMININO">Feminino</option>
                                <option value="NAO_INFORMAR">Não informar</option>
                            </select>
                        </div>

                        <!-- Telefones -->
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="fw-bold mt-2 mb-0">Telefones</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary"
                                    (click)="adicionarTelefone()">
                                    <i class="bi bi-plus-circle"></i> Adicionar Telefone
                                </button>
                            </div>
                        </div>
                        <div class="col-12" *ngIf="telefones.length > 0">
                            <div class="card">
                                <div class="card-body">
                                    <div *ngFor="let telefone of telefones.controls; let i = index"
                                        [formGroup]="$any(telefone)" class="row g-2 mb-3 align-items-end">
                                        <div class="col-12 col-lg-3">
                                            <label [for]="'tel_tipo_' + i" class="form-label">Tipo</label>
                                            <select class="form-select" [id]="'tel_tipo_' + i" formControlName="tipo">
                                                <option *ngFor="let t of tiposTelefone" [value]="t.value">{{t.label}}
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-12 col-lg-5">
                                            <label [for]="'tel_valor_' + i" class="form-label">Número</label>
                                            <input type="text" class="form-control" [id]="'tel_valor_' + i"
                                                formControlName="valor" placeholder="(00) 00000-0000"
                                                [mask]="getTelTipo(i) === 'FIXO' ? '(00) 0000-0000' : '(00) 00000-0000'">
                                        </div>
                                        <div class="col-12 col-lg-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" [name]="'principal'"
                                                    [id]="'principal_' + i" [checked]="telefone.get('principal')?.value"
                                                    (change)="marcarComoPrincipal(i)">
                                                <label class="form-check-label" [for]="'principal_' + i">
                                                    Principal
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-2">
                                            <button type="button" class="btn btn-danger w-100"
                                                (click)="removerTelefone(i)">
                                                <i class="bi bi-trash"></i> Remover
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12" *ngIf="telefones.length === 0">
                            <div class="alert alert-info">
                                Nenhum telefone cadastrado. Clique em "Adicionar Telefone" para incluir.
                            </div>
                        </div>

                        <!-- Endereço -->
                        <div class="col-12">
                            <h6 class="fw-bold mt-2">Endereço</h6>
                        </div>
                        <div class="col-12 col-lg-3" formGroupName="endereco">
                            <label for="cep" class="form-label">CEP</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="cep" formControlName="cep" mask="00000-000"
                                    placeholder="00000-000">
                                <button class="btn btn-outline-secondary" type="button" (click)="consultarCEP()"
                                    [disabled]="loadingCep">
                                    <span *ngIf="!loadingCep">Buscar</span>
                                    <span *ngIf="loadingCep" class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </span>
                                </button>
                            </div>
                        </div>
                        <div class="col-12 col-lg-7" formGroupName="endereco">
                            <label for="logradouro" class="form-label">Logradouro</label>
                            <input type="text" class="form-control" id="logradouro" formControlName="logradouro"
                                placeholder="Rua, Avenida, etc.">
                        </div>
                        <div class="col-12 col-lg-2" formGroupName="endereco">
                            <label for="numero" class="form-label">Número</label>
                            <input type="text" class="form-control" id="numero" formControlName="numero"
                                placeholder="123">
                        </div>
                        <div class="col-12 col-lg-4" formGroupName="endereco">
                            <label for="bairro" class="form-label">Bairro</label>
                            <input type="text" class="form-control" id="bairro" formControlName="bairro"
                                placeholder="Bairro">
                        </div>
                        <div class="col-12 col-lg-8" formGroupName="endereco">
                            <label for="complemento" class="form-label">Complemento</label>
                            <input type="text" class="form-control" id="complemento" formControlName="complemento"
                                placeholder="Apto, Bloco, etc.">
                        </div>
                        <div class="col-12 col-lg-4" formGroupName="endereco">
                            <label for="estado" class="form-label">Estado</label>
                            <select class="form-select" id="estado" formControlName="estado">
                                <option value="">Selecione</option>
                                <option *ngFor="let estado of estados" [value]="estado.sigla">{{estado.sigla}}</option>
                            </select>
                        </div>
                        <div class="col-12 col-lg-8" formGroupName="endereco">
                            <label for="cidade" class="form-label">Cidade</label>
                            <select class="form-select" id="cidade" formControlName="cidade"
                                [disabled]="!form.get('endereco.estado')?.value">
                                <option value="">Selecione</option>
                                <option *ngFor="let cidade of cidades" [value]="cidade.nome">{{cidade.nome}}</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <h6 class="fw-bold mt-2">Recebimentos (Cobrança)</h6>
                        </div>
                        <div class="col-12 col-lg-6">
                            <label for="dias_cobranca" class="form-label">Dias máximo para cobrança</label>
                            <input type="number" class="form-control" id="dias_cobranca" formControlName="dias_cobranca"
                                placeholder="Dias">
                        </div>


                        <!-- Botões -->
                        <div class="col-12" [class.mt-3]="isModal">
                            <button type="submit" class="btn btn-success" [disabled]="form.invalid || loading">
                                <text-spinner [loading]="loading">Salvar</text-spinner>
                            </button>
                            <button type="button" class="btn btn-danger ms-2" (click)="back()" [disabled]="loading">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </form>
                <div class="card-footer" *ngIf="!!user_data?._id">
                    <div class="row">
                        <div class="col-12 col-lg-4">
                            <p class="text-muted fw-bold mb-0">Criado por</p>
                            <p class="text-muted mb-0" *ngIf="!!user_data?.criado_por?.data_hora">
                                {{user_data?.criado_por?.usuario | userInfo}} {{user_data?.criado_por?.data_hora |
                                dateFromNow}}</p>
                            <p class="text-muted mb-0" *ngIf="!user_data?.criado_por?.data_hora">---</p>
                        </div>
                        <div class="col-12 col-lg-4">
                            <p class="text-muted fw-bold mb-0">Alterado por</p>
                            <p class="text-muted mb-0" *ngIf="!!user_data?.atualizado_por?.data_hora">
                                {{user_data?.atualizado_por?.usuario | userInfo}}
                                {{user_data?.atualizado_por?.data_hora | dateFromNow}}</p>
                            <p class="text-muted mb-0" *ngIf="!user_data?.atualizado_por?.data_hora">---</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>