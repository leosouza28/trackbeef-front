<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="fw-bold mb-0">Lançamentos do Caixa</h1>
                </div>
                <button type="button" class="btn btn-outline-secondary me-3" (click)="voltar()">
                    <i class="bi bi-arrow-left"></i> Voltar
                </button>
            </div>
        </div>

        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <!-- Informações do Caixa -->
                <div class="alert alert-light m-3 mb-0" *ngIf="caixa">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Nome:</strong><br>
                            {{ caixa.nome }}
                            <span class="badge bg-primary ms-2" *ngIf="caixa.principal">Principal</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Saldo Atual:</strong><br>
                            <span class="fs-5" [class.text-success]="caixa.saldo >= 0"
                                [class.text-danger]="caixa.saldo < 0">
                                {{ caixa.saldo | moneyBrl }}
                            </span>
                        </div>
                        <div class="col-md-3">
                            <strong>Última Movimentação:</strong><br>
                            {{ caixa.updatedAt | date: 'dd/MM/yy HH:mm' }}
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <form [formGroup]="form" (submit)="query()" class="p-3">
                    <div class="row g-3">
                        <!-- Data Inicial -->
                        <div class="col-md-3">
                            <label for="data-inicial" class="form-label fw-bold">Data Inicial</label>
                            <input type="date" class="form-control" id="data-inicial" formControlName="data_inicial">
                        </div>

                        <!-- Data Final -->
                        <div class="col-md-3">
                            <label for="data-final" class="form-label fw-bold">Data Final</label>
                            <input type="date" class="form-control" id="data-final" formControlName="data_final">
                        </div>

                        <!-- Busca -->
                        <div class="col-md-4">
                            <label for="input-busca" class="form-label fw-bold">Buscar</label>
                            <input type="text" class="form-control" id="input-busca" formControlName="busca"
                                placeholder="Descrição, valor, referência">
                        </div>

                        <!-- Tipo de Lançamento -->
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Tipo</label>
                            <app-multi-checkbox-select [options]="tipoLancamentoOptions" formControlName="tipo"
                                placeholder="Todos">
                            </app-multi-checkbox-select>
                        </div>
                    </div>

                    <!-- Botões de ação -->
                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search me-2"></i> Buscar
                        </button>
                        <button type="button" class="btn btn-secondary" (click)="limparFiltros()">
                            <i class="bi bi-x-circle me-2"></i> Limpar Filtros
                        </button>
                    </div>
                </form>

                <!-- Lançamentos Agrupados por Data -->
                <div class="px-3 pb-3">
                    <div *ngIf="loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>

                    <div *ngIf="!loading && getLancamentosPorData().length === 0" class="alert alert-info text-center">
                        <i class="bi bi-info-circle me-2"></i>
                        Nenhum lançamento encontrado no período selecionado.
                    </div>

                    <!-- Grupos por Data -->
                    <div *ngFor="let grupo of getLancamentosPorData()" class="mb-4">
                        <!-- Cabeçalho da Data -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-primary text-white">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <h5 class="mb-0">
                                            <i class="bi bi-calendar3 me-2"></i>
                                            {{ grupo.dataFormatada }} - {{ grupo.diaSemana }}
                                        </h5>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="row text-end">
                                            <div class="col-4" *ngIf="grupo.totalEntradas > 0">
                                                <small class="d-block opacity-75">Entradas</small>
                                                <strong class="fs-6">{{ grupo.totalEntradas | moneyBrl }}</strong>
                                            </div>
                                            <div class="col-4" *ngIf="grupo.totalSaidas > 0">
                                                <small class="d-block opacity-75">Saídas</small>
                                                <strong class="fs-6">{{ grupo.totalSaidas | moneyBrl }}</strong>
                                            </div>
                                            <div class="col-4">
                                                <small class="d-block opacity-75">Total do Dia</small>
                                                <strong class="fs-5" [class.text-warning]="grupo.totalGeral < 0">
                                                    {{ grupo.totalGeral | moneyBrl }}
                                                </strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Lançamentos do Dia -->
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 100px;">Tipo</th>
                                                <th>Descrição</th>
                                                <th style="width: 200px;">Ref.</th>
                                                <th style="width: 150px;" class="text-end">Valor</th>
                                                <th style="width: 150px;">Usuário</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr *ngFor="let lancamento of grupo.lancamentos">
                                                <td>
                                                    <span class="badge" 
                                                          [class.bg-success]="lancamento.tipo_operacao === 'ENTRADA'"
                                                          [class.bg-danger]="lancamento.tipo_operacao === 'SAIDA'"
                                                          [class.bg-info]="lancamento.tipo_operacao === 'TRANSFERENCIA'">
                                                        {{ lancamento.tipo_operacao }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="fw-bold">{{ lancamento.label }}</div>
                                                    <small class="text-muted" *ngIf="lancamento.observacao">
                                                        {{ lancamento.observacao }}
                                                    </small>
                                                </td>
                                                <td>
                                                    <div *ngIf="lancamento.nota">
                                                        <strong>{{ lancamento.nota.numero_nota }}</strong><br>
                                                        <small class="text-muted">
                                                            {{ lancamento.nota.fornecedor?.nome || lancamento.nota.fornecedor?.razao_social }}
                                                        </small>
                                                    </div>
                                                    <div *ngIf="lancamento.venda">
                                                        <strong>{{ lancamento.venda.codigo }}</strong><br>
                                                        <small class="text-muted">
                                                            {{ lancamento.venda.cliente?.nome || lancamento.venda.cliente?.razao_social }}
                                                        </small>
                                                    </div>
                                                </td>
                                                <td class="text-end">
                                                    <strong class="fs-6"
                                                            [class.text-success]="lancamento.tipo_operacao === 'ENTRADA'"
                                                            [class.text-danger]="lancamento.tipo_operacao === 'SAIDA'">
                                                        {{ lancamento.valor | moneyBrl }}
                                                    </strong>
                                                </td>
                                                <td>
                                                    <div>{{ lancamento.criado_por?.usuario?.nome || '-' }}</div>
                                                    <small class="text-muted">
                                                        {{ lancamento.criado_por?.data_hora | date:'HH:mm' }}
                                                    </small>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Consolidados -->
                    <div class="row mt-4" *ngIf="!loading && (getConsolidadoOperacao().length > 0 || getConsolidadoDescricao().length > 0)">
                        <!-- Consolidado por Tipo de Operação -->
                        <div class="col-md-6 mb-3" *ngIf="getConsolidadoOperacao().length > 0">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-dark text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-pie-chart me-2"></i>
                                        Consolidado por Operação
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm mb-0">
                                        <tbody>
                                            <tr *ngFor="let item of getConsolidadoOperacao()">
                                                <td style="width: 120px;">
                                                    <span class="badge"
                                                          [class.bg-success]="item.tipo_operacao === 'ENTRADA'"
                                                          [class.bg-danger]="item.tipo_operacao === 'SAIDA'"
                                                          [class.bg-info]="item.tipo_operacao === 'TRANSFERENCIA'">
                                                        {{ item.tipo_operacao }}
                                                    </span>
                                                </td>
                                                <td class="text-end">
                                                    <strong class="fs-5"
                                                            [class.text-success]="item.valor >= 0"
                                                            [class.text-danger]="item.valor < 0">
                                                        {{ item.valor | moneyBrl }}
                                                    </strong>
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot class="table-light border-top border-2">
                                            <tr>
                                                <td><strong>TOTAL GERAL</strong></td>
                                                <td class="text-end">
                                                    <strong class="fs-4 text-primary">
                                                        {{ getTotalConsolidado(getConsolidadoOperacao()) | moneyBrl }}
                                                    </strong>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Consolidado por Descrição -->
                        <div class="col-md-6 mb-3" *ngIf="getConsolidadoDescricao().length > 0">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-dark text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-bar-chart me-2"></i>
                                        Consolidado por Descrição
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm mb-0">
                                        <tbody>
                                            <tr *ngFor="let item of getConsolidadoDescricao()">
                                                <td>
                                                    <strong>{{ item.descricao }}</strong>
                                                </td>
                                                <td class="text-end" style="width: 150px;">
                                                    <strong class="fs-6"
                                                            [class.text-success]="item.valor >= 0"
                                                            [class.text-danger]="item.valor < 0">
                                                        {{ item.valor | moneyBrl }}
                                                    </strong>
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot class="table-light border-top border-2">
                                            <tr>
                                                <td><strong>TOTAL GERAL</strong></td>
                                                <td class="text-end">
                                                    <strong class="fs-4 text-primary">
                                                        {{ getTotalConsolidado(getConsolidadoDescricao()) | moneyBrl }}
                                                    </strong>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>