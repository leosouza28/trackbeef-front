<div [class.modal-header]="isModal" *ngIf="isModal">
    <h5 class="modal-title">{{form.get('_id')?.value ? 'Editar' : 'Adicionar'}} Produto</h5>
    <button type="button" class="btn-close" (click)="back()" [disabled]="loading"></button>
</div>

<div [class.container-fluid]="!isModal" [class.modal-body]="isModal">
    <div class="row" *ngIf="!isModal">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="fw-bold mb-0">{{form.get('_id')?.value ? 'Editar' : 'Adicionar'}} Produto</h1>
                <app-help-button helpKey="produtos-form" size="md"></app-help-button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div [class.card]="!isModal" [class.border-0]="!isModal" [class.shadow]="!isModal">
                <p class="text-muted" [class.px-3]="!isModal" [class.pt-3]="!isModal">Os campos com * são obrigatórios
                </p>
                <form [formGroup]="form" (ngSubmit)="onSubmit()" [class.px-3]="!isModal" [class.pb-3]="!isModal">
                    <div class="row g-3">

                        <!-- SKU -->
                        <div class="col-12 ">
                            <label for="sku" class="form-label">SKU / Código</label>
                            <input type="text" class="form-control" id="sku" formControlName="sku"
                                placeholder="Código do produto">
                        </div>

                        <!-- Nome * -->
                        <div class="col-12 col-lg-8">
                            <label for="nome" class="form-label">Nome do Produto *</label>
                            <input type="text" class="form-control" id="nome" formControlName="nome"
                                placeholder="Nome do produto">
                            <div class="text-danger small mt-1"
                                *ngIf="form.get('nome')?.invalid && form.get('nome')?.touched">
                                O nome do produto é obrigatório
                            </div>
                        </div>

                        <!-- Sigla -->
                        <div class="col-12 col-lg-4">
                            <label for="sigla" class="form-label">Sigla</label>
                            <input type="text" class="form-control" id="sigla" formControlName="sigla"
                                placeholder="Sigla do produto">
                        </div>

                        <!-- Categoria * -->
                        <div class="col-12 col-lg-4">
                            <label for="tipo_saida" class="form-label">Tipo&nbsp;Saída</label>
                            <select class="form-select" id="tipo_saida" formControlName="tipo_saida">
                                <option value="ESTOQUE PADRAO">PADRÃO</option>
                                <option value="ESTOQUE PECA">POR PEÇA</option>
                            </select>
                            <div class="text-danger small mt-1"
                                *ngIf="form.get('tipo_saida')?.invalid && form.get('tipo_saida')?.touched">
                                O tipo de saída é obrigatório
                            </div>
                        </div>

                        <div class="col-12 col-lg-4">
                            <label for="categoria" class="form-label">Categoria *</label>
                            <select class="form-select" id="categoria" formControlName="categoria">
                                <option value="">Selecione</option>
                                <option *ngFor="let cat of categorias" [value]="cat.value">{{cat.label}}</option>
                            </select>
                            <div class="text-danger small mt-1"
                                *ngIf="form.get('categoria')?.invalid && form.get('categoria')?.touched">
                                A categoria é obrigatória
                            </div>
                        </div>

                        <!-- Unidade * -->
                        <div class="col-12 col-lg-4">
                            <label for="unidade" class="form-label">Unidade *</label>
                            <select class="form-select" id="unidade" formControlName="unidade">
                                <option *ngFor="let un of unidades" [value]="un.value">{{un.label}}</option>
                            </select>
                        </div>


                        <!-- Status * -->
                        <div class="col-12 col-lg-4">
                            <label for="status" class="form-label">Status *</label>
                            <select class="form-select" id="status" formControlName="status">
                                <option *ngFor="let st of statusOptions" [value]="st.value">{{st.label}}</option>
                            </select>
                        </div>

                        <div class="col-12 col-lg-4">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="calcula_rendimento_entrada_nota"
                                    formControlName="calcula_rendimento_entrada_nota">
                                <label class="form-check-label" for="calcula_rendimento_entrada_nota">
                                    Calcular rendimento na entrada de nota
                                </label>
                            </div>
                        </div>


                        <!-- Preços -->
                        <div class="col-12">
                            <h6 class="fw-bold mt-2">Preços</h6>
                        </div>

                        <!-- Custo Médio -->
                        <div class="col-12 col-lg-4">
                            <label for="custo_medio" class="form-label">Custo Médio</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input class="form-control" id="custo_medio" formControlName="custo_medio"
                                    placeholder="0.00" currencyMask>
                            </div>
                        </div>

                        <!-- Preço de Custo * -->
                        <div class="col-12 col-lg-4">
                            <label for="preco_custo" class="form-label">Preço de Custo *</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input class="form-control" id="preco_custo" formControlName="preco_custo"
                                    placeholder="0.00" currencyMask>
                            </div>
                            <div class="text-danger small mt-1"
                                *ngIf="form.get('preco_custo')?.invalid && form.get('preco_custo')?.touched">
                                O preço de custo é obrigatório
                            </div>
                        </div>

                        <!-- Preço de Venda * -->
                        <div class="col-12 col-lg-4">
                            <label for="preco_venda" class="form-label">Preço de Venda *</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input class="form-control" id="preco_venda" formControlName="preco_venda"
                                    placeholder="0.00" currencyMask>
                            </div>
                            <div class="text-danger small mt-1"
                                *ngIf="form.get('preco_venda')?.invalid && form.get('preco_venda')?.touched">
                                O preço de venda é obrigatório
                            </div>
                        </div>

                        <!-- Margem de Lucro -->
                        <!-- <div class="col-12" *ngIf="form.get('preco_custo')?.value > 0 && form.get('preco_venda')?.value > 0">
                            <div class="alert alert-info">
                                <strong>Margem de Lucro:</strong> 
                                {{ ((form.get('preco_venda')?.value - form.get('preco_custo')?.value) / form.get('preco_custo')?.value * 100).toFixed(2) }}%
                                (R$ {{ (form.get('preco_venda')?.value - form.get('preco_custo')?.value).toFixed(2) }})
                            </div>
                        </div> -->

                        <!-- Botões -->
                        <div class="col-12" [class.mt-3]="isModal">
                            <button type="submit" class="btn btn-success" [disabled]="form.invalid || loading">
                                <text-spinner [loading]="loading">Salvar</text-spinner>
                            </button>
                            <button type="button" class="btn btn-danger ms-2" (click)="back()" [disabled]="loading">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </form>
                <div class="card-footer" *ngIf="!!produto_data?._id && !isModal">
                    <div class="row">
                        <div class="col-12 col-lg-6">
                            <p class="text-muted fw-bold mb-0">Criado por</p>
                            <p class="text-muted mb-0" *ngIf="!!produto_data?.criado_por?.data_hora">
                                {{produto_data?.criado_por?.usuario | userInfo}} {{produto_data?.criado_por?.data_hora |
                                dateFromNow}}</p>
                            <p class="text-muted mb-0" *ngIf="!produto_data?.criado_por?.data_hora">---</p>
                        </div>
                        <div class="col-12 col-lg-6">
                            <p class="text-muted fw-bold mb-0">Alterado por</p>
                            <p class="text-muted mb-0" *ngIf="!!produto_data?.atualizado_por?.data_hora">
                                {{produto_data?.atualizado_por?.usuario | userInfo}}
                                {{produto_data?.atualizado_por?.data_hora | dateFromNow}}</p>
                            <p class="text-muted mb-0" *ngIf="!produto_data?.atualizado_por?.data_hora">---</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>