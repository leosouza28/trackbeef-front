<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="fw-bold">Visualizar Almoxarifado</h1>
        </div>

        <!-- Resumo dos Produtos -->
        <div class="col-12 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>Resumo do Estoque</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 col-md-6 col-lg-3 mb-3">
                            <div class="card bg-light h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Total de Produtos</h6>
                                    <h3 class="fw-bold text-primary mb-0">{{ data.lista?.length || 0 }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-lg-3 mb-3">
                            <div class="card bg-light h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Total de Peças</h6>
                                    <h3 class="fw-bold text-info mb-0">{{ data.lista_pecas?.length || 0 }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-lg-3 mb-3">
                            <div class="card bg-light h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Quantidade Total (KG/UN)</h6>
                                    <h3 class="fw-bold text-success mb-0">{{ data.total_itens_estoque | number:'1.2-2' }}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-lg-3 mb-3">
                            <div class="card bg-light h-100">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Valor Total</h6>
                                    <h3 class="fw-bold text-warning mb-0">{{ data.valor_total_estoque | moneyBrl }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Produtos em Estoque -->
                    <div class="mt-3" *ngIf="data.lista?.length > 0">
                        <h6 class="fw-bold mb-3">Produtos em Estoque</h6>
                        <div class="row row-gap-3">
                            <div class="col-12" *ngFor="let item of data.lista">
                                <div class="card bg-white border">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-12 col-md-4">
                                                <strong class="d-block">{{ item.produto?.nome || 'N/A' }}</strong>
                                                <small class="text-muted">{{ item.produto?.tipo_saida || '' }}</small>
                                            </div>
                                            <div class="col-12 col-md-3 mt-2 mt-md-0">
                                                <small class="text-muted d-block">Saldo em Estoque</small>
                                                <span class="badge bg-success">{{ item.saldo_estoque | number:'1.2-2' }}</span>
                                            </div>
                                            <div class="col-12 col-md-3 mt-2 mt-md-0">
                                                <small class="text-muted d-block">Saldo Reservado</small>
                                                <span class="badge bg-warning">{{ item.saldo_estoque_reservado | number:'1.2-2' }}</span>
                                            </div>
                                            <div class="col-12 col-md-2 mt-2 mt-md-0">
                                                <span class="badge" [ngClass]="item.saldo_estoque > 0 ? 'bg-success' : 'bg-danger'">
                                                    {{ item.saldo_estoque > 0 ? 'Em Estoque' : 'Sem Estoque' }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Peças com Filtros -->
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Lista de Peças</h5>
                    <span class="badge bg-light text-dark">{{ lista_pecas_filtrada.length }} peças</span>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <div class="row mb-3 p-3 bg-light rounded">
                        <div class="col-12 mb-2">
                            <h6 class="fw-bold"><i class="bi bi-funnel me-2"></i>Filtros</h6>
                        </div>
                        <div class="col-12 col-md-3 mb-2">
                            <label class="form-label">Produto</label>
                            <select class="form-select" [(ngModel)]="filtro_produto" (change)="aplicarFiltros()">
                                <option value="">Todos os produtos</option>
                                <option *ngFor="let produto of produtos_disponiveis" [value]="produto._id">
                                    {{ produto.nome }}
                                </option>
                            </select>
                        </div>
                        <div class="col-12 col-md-2 mb-2">
                            <label class="form-label">Status</label>
                            <select class="form-select" [(ngModel)]="filtro_status" (change)="aplicarFiltros()">
                                <option value="">Todos os status</option>
                                <option value="EM ESTOQUE">Em Estoque</option>
                                <option value="RESERVADO">Reservado</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-2 mb-2">
                            <label class="form-label">Peso maior que (KG)</label>
                            <input type="number" class="form-control" [(ngModel)]="filtro_peso_maior" 
                                   (input)="aplicarFiltros()" placeholder="Ex: 45" step="0.1">
                        </div>
                        <div class="col-12 col-md-2 mb-2">
                            <label class="form-label">Peso menor que (KG)</label>
                            <input type="number" class="form-control" [(ngModel)]="filtro_peso_menor" 
                                   (input)="aplicarFiltros()" placeholder="Ex: 50" step="0.1">
                        </div>
                        <div class="col-12 col-md-2 mb-2">
                            <label class="form-label">Ordenar por peso</label>
                            <select class="form-select" [(ngModel)]="ordem_peso" (change)="ordenarPorPeso()">
                                <option value="desc">Maior para menor</option>
                                <option value="asc">Menor para maior</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-2 mb-2 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-secondary w-100" (click)="limparFiltros()">
                                <i class="bi bi-x-circle me-1"></i> Limpar
                            </button>
                        </div>
                    </div>

                    <!-- Tabela de Peças -->
                    <div class="table-responsive" *ngIf="!loading">
                        <table class="table table-hover table-striped" *ngIf="lista_pecas_filtrada.length > 0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Produto</th>
                                    <th class="text-center">Unidade</th>
                                    <th class="text-end">Peso (KG)</th>
                                    <th class="text-end">Preço Unitário</th>
                                    <th class="text-end">Valor Custo</th>
                                    <th class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let peca of lista_pecas_filtrada" style="cursor: pointer;" (click)="abrirModalDetalhes(peca)">
                                    <td>
                                        <strong>{{ peca.produto?.nome || 'N/A' }}</strong>
                                        <br>
                                        <small class="text-muted">{{ peca.produto?.tipo || '' }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">{{ peca.unidade || peca.produto?.unidade || 'N/A' }}</span>
                                    </td>
                                    <td class="text-end">
                                        <strong>{{ peca.peso | number:'1.2-2' }}</strong>
                                    </td>
                                    <td class="text-end">
                                        {{ peca.preco_custo_unitario | moneyBrl }}
                                    </td>
                                    <td class="text-end">
                                        {{ peca.valor_custo | moneyBrl }}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge" 
                                              [ngClass]="{
                                                'bg-success': peca.status_estoque === 'EM ESTOQUE',
                                                'bg-danger': peca.status_estoque === 'VENDIDO',
                                                'bg-warning': peca.status_estoque !== 'EM ESTOQUE' && peca.status_estoque !== 'VENDIDO'
                                              }">
                                            {{ peca.status_estoque || 'N/A' }}
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <!-- Mensagem quando não há peças -->
                        <div *ngIf="lista_pecas_filtrada.length === 0" class="text-center py-5">
                            <i class="bi bi-inbox display-1 text-muted"></i>
                            <p class="text-muted mt-3">Nenhuma peça encontrada com os filtros aplicados.</p>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div *ngIf="loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="text-muted mt-3">Carregando dados...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes da Peça -->
<div class="modal fade" [class.show]="mostrarModalDetalhes" [style.display]="mostrarModalDetalhes ? 'block' : 'none'"
    tabindex="-1" (click)="fecharModalDetalhes()">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" (click)="$event.stopPropagation()">
        <div class="modal-content" *ngIf="pecaSelecionadaDetalhes">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle me-2"></i>Detalhes da Peça
                </h5>
                <button type="button" class="btn-close btn-close-white" (click)="fecharModalDetalhes()"></button>
            </div>
            <div class="modal-body">
                <!-- Status Badge -->
                <div class="mb-3 text-center">
                    <span class="badge fs-5 px-4 py-2" 
                          [ngClass]="{
                            'bg-success': pecaSelecionadaDetalhes.status_estoque === 'EM ESTOQUE',
                            'bg-danger': pecaSelecionadaDetalhes.status_estoque === 'VENDIDO',
                            'bg-warning': pecaSelecionadaDetalhes.status_estoque === 'RESERVADO'
                          }">
                        {{ pecaSelecionadaDetalhes.status_estoque || 'N/A' }}
                    </span>
                </div>

                <!-- Informações do Produto -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-box-seam me-2"></i>Produto</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 mb-2">
                                <strong class="text-muted">Nome:</strong>
                                <div class="fs-5">{{ pecaSelecionadaDetalhes.produto?.nome || 'N/A' }}</div>
                            </div>
                            <div class="col-6 mb-2">
                                <strong class="text-muted">SKU:</strong>
                                <div>{{ pecaSelecionadaDetalhes.produto?.sku || 'N/A' }}</div>
                            </div>
                            <div class="col-6 mb-2">
                                <strong class="text-muted">Tipo:</strong>
                                <div>{{ pecaSelecionadaDetalhes.produto?.tipo_saida || 'N/A' }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informações de Peso e Valores -->
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="bi bi-calculator me-2"></i>Medidas e Valores</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <strong class="text-muted">Peso:</strong>
                                <div class="fs-4 text-success fw-bold">
                                    {{ pecaSelecionadaDetalhes.peso | number:'1.2-2' }} {{ pecaSelecionadaDetalhes.unidade }}
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <strong class="text-muted">Unidade:</strong>
                                <div class="fs-5">
                                    <span class="badge bg-info">{{ pecaSelecionadaDetalhes.unidade || 'N/A' }}</span>
                                </div>
                            </div>
                            <div class="col-6 mb-2">
                                <strong class="text-muted">Preço Custo Unitário:</strong>
                                <div>{{ pecaSelecionadaDetalhes.preco_custo_unitario | moneyBrl }}</div>
                            </div>
                            <div class="col-6 mb-2">
                                <strong class="text-muted">Valor Custo:</strong>
                                <div>{{ pecaSelecionadaDetalhes.valor_custo | moneyBrl }}</div>
                            </div>
                            <div class="col-6 mb-2">
                                <strong class="text-muted">Valor Total:</strong>
                                <div class="fw-bold text-warning fs-5">{{ pecaSelecionadaDetalhes.valor_total | moneyBrl }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informações da Nota (se existir) -->
                <div class="card mb-3" *ngIf="pecaSelecionadaDetalhes.nota && Object.keys(pecaSelecionadaDetalhes.nota).length > 0">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="bi bi-receipt me-2"></i>Nota Fiscal</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-2" *ngIf="pecaSelecionadaDetalhes.nota.numero_nota">
                                <strong class="text-muted">Número:</strong>
                                <div>{{ pecaSelecionadaDetalhes.nota.numero_nota }}</div>
                            </div>
                            <div class="col-6 mb-2" *ngIf="pecaSelecionadaDetalhes.nota.data_nota">
                                <strong class="text-muted">Data:</strong>
                                <div>{{ pecaSelecionadaDetalhes.nota.data_nota | date:'dd/MM/yyyy' }}</div>
                            </div>
                            <div class="col-12 mb-2" *ngIf="pecaSelecionadaDetalhes.nota.fornecedor?.nome">
                                <strong class="text-muted">Fornecedor:</strong>
                                <div>{{ pecaSelecionadaDetalhes.nota.fornecedor.nome }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informações do Almoxarifado e Empresa -->
                <div class="card mb-3">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0"><i class="bi bi-building me-2"></i>Localização</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-2">
                                <strong class="text-muted">Almoxarifado:</strong>
                                <div>{{ pecaSelecionadaDetalhes.almoxarifado?.nome || 'N/A' }}</div>
                            </div>
                            <div class="col-6 mb-2">
                                <strong class="text-muted">Empresa:</strong>
                                <div>{{ pecaSelecionadaDetalhes.empresa?.nome || 'N/A' }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informações da Venda (se existir) -->
                <div class="card mb-3" *ngIf="pecaSelecionadaDetalhes.venda">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0"><i class="bi bi-cart-check me-2"></i>Venda</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-2">
                                <strong class="text-muted">Código:</strong>
                                <div class="fw-bold">{{ pecaSelecionadaDetalhes.venda.codigo }}</div>
                            </div>
                            <div class="col-6 mb-2">
                                <strong class="text-muted">Data:</strong>
                                <div>{{ pecaSelecionadaDetalhes.venda.data | date:'dd/MM/yyyy' }}</div>
                            </div>
                            <div class="col-12 mb-2">
                                <strong class="text-muted">Cliente:</strong>
                                <div>{{ pecaSelecionadaDetalhes.venda.cliente?.nome || 'Sem cliente informado' }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Datas -->
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h6 class="mb-0"><i class="bi bi-calendar me-2"></i>Datas</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-2">
                                <strong class="text-muted">Criado em:</strong>
                                <div>{{ pecaSelecionadaDetalhes.createdAt | date:'dd/MM/yyyy HH:mm' }}</div>
                            </div>
                            <div class="col-6 mb-2">
                                <strong class="text-muted">Atualizado em:</strong>
                                <div>{{ pecaSelecionadaDetalhes.updatedAt | date:'dd/MM/yyyy HH:mm' }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="fecharModalDetalhes()">
                    <i class="bi bi-x-circle me-1"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal-backdrop fade" [class.show]="mostrarModalDetalhes" *ngIf="mostrarModalDetalhes"></div>
